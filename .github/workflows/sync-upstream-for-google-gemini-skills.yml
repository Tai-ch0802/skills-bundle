name: "ðŸ”„ Sync Upstream Skills - google-gemini/gemini-skills"

on:
  schedule:
    # 00:00 UTC+8 = 16:00 UTC (previous day)
    - cron: "0 16 * * *"
  workflow_dispatch:
    inputs:
      hours_lookback:
        description: "Hours to look back for changes (default: 24)"
        required: false
        default: "24"

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # ----------------------------------------------------------------
      # Phase 1: Detect upstream changes
      # ----------------------------------------------------------------
      - name: ðŸ” Detect upstream changes
        id: detect
        env:
          GH_TOKEN: ${{ github.token }}
          LOOKBACK_HOURS: ${{ inputs.hours_lookback || '24' }}
        run: |
          set -euo pipefail

          UPSTREAM_REPO="google-gemini/gemini-skills"
          SINCE_DATE=$(date -u -d "${LOOKBACK_HOURS} hours ago" '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null \
                    || date -u -v-${LOOKBACK_HOURS}H '+%Y-%m-%dT%H:%M:%SZ')

          echo "ðŸ“… Checking ${UPSTREAM_REPO} for changes since ${SINCE_DATE}"
          echo ""

          # --- Collect recent commits ---
          COMMITS=$(gh api "repos/${UPSTREAM_REPO}/commits?since=${SINCE_DATE}&per_page=100" \
            --jq '.[] | "- [\(.sha[0:7])](https://github.com/'"${UPSTREAM_REPO}"'/commit/\(.sha)) \(.commit.message | split("\n")[0]) (by @\(.author.login // .commit.author.name))"' \
            2>&1 || echo "")

          # --- Collect merged PRs ---
          MERGED_PRS=$(gh api "repos/${UPSTREAM_REPO}/pulls?state=closed&sort=updated&direction=desc&per_page=50" \
            --jq '.[] | select(.merged_at != null) | select(.merged_at >= "'"${SINCE_DATE}"'") | "- PR #\(.number): \(.title) (merged by @\(.merged_by.login // "unknown"))"' \
            2>&1 || echo "")

          # --- Check if any changes found ---
          if [ -z "${COMMITS}" ] && [ -z "${MERGED_PRS}" ]; then
            echo "âœ… No changes detected in the last ${LOOKBACK_HOURS} hours. Skipping sync."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ðŸ”” Changes detected!"
          echo ""

          # --- Build change summary ---
          CHANGE_SUMMARY=""

          if [ -n "${COMMITS}" ]; then
            echo "### Recent Commits:"
            echo "${COMMITS}"
            CHANGE_SUMMARY+="## Recent Commits (last ${LOOKBACK_HOURS}h)
          ${COMMITS}

          "
          fi

          if [ -n "${MERGED_PRS}" ]; then
            echo ""
            echo "### Merged PRs:"
            echo "${MERGED_PRS}"
            CHANGE_SUMMARY+="## Merged PRs (last ${LOOKBACK_HOURS}h)
          ${MERGED_PRS}

          "
          fi

          # --- Get list of changed files across all commits ---
          CHANGED_FILES=$(gh api "repos/${UPSTREAM_REPO}/commits?since=${SINCE_DATE}&per_page=100" \
            --jq '.[].sha' 2>&1 | while read -r sha; do
              gh api "repos/${UPSTREAM_REPO}/commits/${sha}" \
                --jq '.files[].filename' 2>&1
            done | sort -u || echo "")

          if [ -n "${CHANGED_FILES}" ]; then
            CHANGE_SUMMARY+="## Changed Files
          ${CHANGED_FILES}
          "
          fi

          echo "has_changes=true" >> "$GITHUB_OUTPUT"

          # Store multi-line summary via GITHUB_OUTPUT heredoc delimiter
          cat << 'SUMMARY_EOF' >> "$GITHUB_OUTPUT"
          change_summary<<EOF
          ${CHANGE_SUMMARY}
          EOF
          SUMMARY_EOF

      # ----------------------------------------------------------------
      # Phase 2: Invoke Jules to sync (only if changes detected)
      # ----------------------------------------------------------------
      - name: ðŸ¤– Invoke Jules to sync upstream changes
        if: steps.detect.outputs.has_changes == 'true'
        uses: google-labs-code/jules-action@v1.0.0
        with:
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          prompt: |
            # Task: Sync Upstream Skill Changes from google-gemini/gemini-skills

            You are a skill synchronization agent for the `skills-bundle` project.
            The upstream repository `https://github.com/google-gemini/gemini-skills` has had
            changes in the past 24 hours. Your job is to sync those changes into this project.

            ## Upstream Changes Detected

            ${{ steps.detect.outputs.change_summary }}

            ## Important: Upstream Directory Structure

            The upstream repo nests skills under `skills/<skill-name>/`, NOT at root level.
            When syncing, you must map:
            - Upstream: `skills/<skill-name>/` â†’ Local: `<skill-name>/`

            ## Instructions

            ### Step 1: Identify what changed upstream

            Clone or fetch `https://github.com/google-gemini/gemini-skills` and compare with
            the skill directories in THIS repo. Focus only on skill directories that exist
            both upstream and locally. The upstream skills are under `skills/` subdirectory.

            **Skills that came from upstream (gemini-skills):**
            gemini-api-dev

            **Skills NOT from upstream (do NOT modify):**
            prd, sa, sdd, refactoring, testing-mastery, code-quality,
            api-patterns, app-builder, architecture, bash-linux, behavioral-modes,
            brainstorming, clean-code, code-review-checklist, database-design,
            deployment-procedures, documentation-templates, frontend-design,
            game-development, geo-fundamentals, i18n-localization, intelligent-routing,
            lint-and-validate, mcp-builder, mobile-design, nextjs-react-expert,
            nodejs-best-practices, parallel-agents, performance-profiling, plan-writing,
            powershell-windows, python-patterns, red-team-tactics, rust-pro,
            seo-fundamentals, server-management, systematic-debugging, tailwind-patterns,
            tdd-workflow, testing-patterns, vulnerability-scanner, web-design-guidelines,
            webapp-testing

            ### Step 2: Sync changed skills

            For each skill that has changes upstream:
            1. Copy the updated files from upstream `skills/<skill-name>/` to the
               corresponding local directory `<skill-name>/`
            2. If upstream added a NEW skill directory under `skills/` that doesn't exist
               locally, create it at the repo root and add it to `bin/install.mjs`:
               - Add to the `SKILLS` array (alphabetical order)
               - Add to `DEPENDENCIES` (empty array if no dependencies)
               - Add English description in `LANGUAGES.en.messages.skillDescriptions`
               - Add Traditional Chinese (zh-TW) description in `LANGUAGES['zh-TW'].messages.skillDescriptions`
               - Add to `package.json` `files` array (alphabetical order)
            3. If upstream deleted a skill, remove it from the local repo, `bin/install.mjs`,
               and `package.json`

            ### Step 3: Update zh-TW translations

            For each modified or new skill, update the corresponding file under
            `i18n/zh-TW/<skill-name>/`. Translate the SKILL.md and any reference files
            to Traditional Chinese. Keep the same file structure.

            ### Step 4: Update README.md

            If new skills were added or existing skills removed:
            1. Update the skill count in "Available Skills (N)"
            2. Update the "Gemini API Skills" section with new/removed entries
            3. Update the Skill Sources table if the skill list changed
            4. Update GEMINI.md if needed

            ### Step 5: Create PR

            Create a pull request with:
            - **Title**: `sync: update skills from upstream gemini-skills`
            - **Body**: Include a clear summary of:
              - Which upstream commits/PRs triggered this sync
              - Which skill directories were updated
              - What changes were made to `bin/install.mjs` (if any)
              - What zh-TW translations were added/updated

            ## Rules

            - Do NOT modify skills that are NOT from upstream gemini-skills
            - ONLY create a PR if there are actual file changes to sync
            - If after analysis no files actually differ, do NOT create a PR
            - All existing tests and lint must pass
            - Keep `bin/install.mjs` consistent with locally available skill directories
            - Remember: upstream path is `skills/<name>/`, local path is `<name>/`
