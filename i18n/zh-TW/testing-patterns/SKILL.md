---
name: testing-patterns
description: 測試模式與原則。單元測試、整合測試、模擬策略。
allowed-tools: Read, Write, Edit, Glob, Grep, Bash
---

# 測試模式

> 可靠測試套件的原則。

---

## 1. 測試金字塔

```
        /\          E2E（少量）
       /  \         關鍵流程
      /----\
     /      \       整合（一些）
    /--------\      API、DB 查詢
   /          \
  /------------\    單元（大量）
                    函式、類別
```

---

## 2. AAA 模式

| 步驟 | 用途 |
|------|------|
| **Arrange** | 設置測試資料 |
| **Act** | 執行受測程式碼 |
| **Assert** | 驗證結果 |

---

## 3. 測試類型選擇

### 何時使用各類

| 類型 | 最適合 | 速度 |
|------|--------|------|
| **單元** | 純函式、邏輯 | 快（<50ms）|
| **整合** | API、DB、服務 | 中等 |
| **E2E** | 關鍵使用者流程 | 慢 |

---

## 4. 單元測試原則

### 好的單元測試

| 原則 | 意義 |
|------|------|
| 快速 | 每個 < 100ms |
| 隔離 | 無外部依賴 |
| 可重複 | 結果永遠相同 |
| 自我檢查 | 無需手動驗證 |
| 及時 | 與程式碼一起寫 |

### 要測試什麼

| 測試 | 不測試 |
|------|--------|
| 業務邏輯 | 框架程式碼 |
| 邊界情況 | 第三方函式庫 |
| 錯誤處理 | 簡單 getter |

---

## 5. 整合測試原則

### 要測試什麼

| 領域 | 焦點 |
|------|------|
| API 端點 | 請求/回應 |
| 資料庫 | 查詢、交易 |
| 外部服務 | 契約 |

### 設置/清除

| 階段 | 動作 |
|------|------|
| Before All | 連線資源 |
| Before Each | 重置狀態 |
| After Each | 清理 |
| After All | 斷線 |

---

## 6. 模擬原則

### 何時模擬

| 模擬 | 不模擬 |
|------|--------|
| 外部 API | 受測程式碼 |
| 資料庫（單元）| 簡單依賴 |
| 時間/隨機 | 純函式 |
| 網路 | 記憶體內儲存 |

### 模擬類型

| 類型 | 用途 |
|------|------|
| Stub | 回傳固定值 |
| Spy | 追蹤呼叫 |
| Mock | 設定預期 |
| Fake | 簡化實作 |

---

## 7. 測試組織

### 命名

| 模式 | 範例 |
|------|------|
| Should 行為 | 「should return error when...」|
| When 條件 | 「when user not found...」|
| Given-when-then | 「given X, when Y, then Z」|

---

## 8. 測試資料

### 策略

| 方法 | 用途 |
|------|------|
| 工廠 | 產生測試資料 |
| 固定資料 | 預定義資料集 |
| 建構器 | 流暢物件建立 |

---

## 9. 最佳實踐

| 實踐 | 原因 |
|------|------|
| 每測試一個斷言 | 清晰的失敗原因 |
| 獨立測試 | 無順序依賴 |
| 快速測試 | 頻繁執行 |
| 描述性名稱 | 自文件化 |
| 清理 | 避免副作用 |

---

## 10. 反模式

| ❌ 不要 | ✅ 要 |
|---------|-------|
| 測試實作 | 測試行為 |
| 重複測試程式碼 | 使用工廠 |
| 複雜測試設置 | 簡化或拆分 |
| 忽略不穩定測試 | 修復根本原因 |
| 跳過清理 | 重置狀態 |

---

> **記住：** 測試是文件。如果有人無法從測試理解程式碼做什麼，重寫它們。
